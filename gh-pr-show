#!/usr/bin/env bash

if [ ! -d .git ]
then
    echo "The current directory is not a git repository!"
    exit
fi

REPOINFO=$(gh repo view --json owner,name |jq -r '.name,.owner.login')
OWNER=$(echo $REPOINFO|awk '{print $2}')
REPO=$(echo $REPOINFO|awk '{print $1}')

#LAST=$(gh pr list --limit 1 --state all --json number|jq '.[].number')
LAST=2

template='
{{- range $pr := .data.repository.pullRequests.nodes -}}
{{- tablerow (printf "%v" .number) (printf "%v" .title| autocolor "green") -}}
{{- end -}}

{{ if eq (len .data.repository.pullRequests.nodes) 0 }}
{{- printf "No pull requests match your filter" -}}
{{ else }}
{{- tablerender -}}
{{ end }}
'

query='
query ($owner: String!, $name: String!, $prlast: Int!) {
  repository(owner: $owner, name: $name) {
    pullRequests(last: 10) {
      nodes {
        id
        number
        title
      }
    }
    id
    createdAt
    pullRequest(number: $prlast) {
      reviews(last: 10) {
        nodes {
          author {
            login
          }
          bodyText
          comments(last: 10) {
            nodes {
              bodyText
            }
            totalCount
          }
        }
      }
    }
  }
}'

gh api graphql -F owner="$OWNER" -F name="$REPO" -F prlast=${LAST} -f query="$query" --template="$template"




