#!/usr/bin/env bash

echo "Welcome to use gh-pr-show!"

if [ ! -d .git ]
then
    echo "The current directory is not a git repository!"
    exit
fi

REPOINFO=$(gh repo view --json owner,name |jq -r '.name,.owner.login')

LAST=$(gh pr list --limit 1 --state all --json number|jq '.[].number')
#LAST=2

if [ x == ${LAST}x ]
then
    echo "There is no open pull request, specify one PR number to show!"
    exit
fi

get_review_ids () {
    gh api repos/$(echo $REPOINFO|awk '{print $2}')/$(echo $REPOINFO|awk '{print $1}')/pulls/${LAST:-2}/reviews|jq '.[].id'
}


for id in $(get_review_ids)
do
    gh api repos/$(echo $REPOINFO|awk '{print $2}')/$(echo $REPOINFO|awk '{print $1}')/pulls/${LAST:-2}/reviews/${id}|jq -r '.user.login, "---------------------",.body'
    gh api repos/$(echo $REPOINFO|awk '{print $2}')/$(echo $REPOINFO|awk '{print $1}')/pulls/${LAST:-2}/reviews/${id}/comments|jq -r '.[].body'
    echo
done
